import streamlit as st
import chess
import chess.svg
import cairosvg
from stockfish import Stockfish
import os

# === ì‚¬ìš©ì ì„¤ì • ===
STOCKFISH_PATH = "C:/Users/yourname/Downloads/stockfish/stockfish.exe"  # â† ì—¬ê¸°ì— ë³¸ì¸ ê²½ë¡œ ì…ë ¥í•˜ì„¸ìš”
if not os.path.isfile(STOCKFISH_PATH):
    st.error("âŒ Stockfish ì‹¤í–‰ íŒŒì¼ ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œì—ì„œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.")
    st.stop()

# Stockfish ì´ˆê¸°í™”
stockfish = Stockfish(path=STOCKFISH_PATH, parameters={"Threads": 2, "Minimum Thinking Time": 100})

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "board" not in st.session_state:
    st.session_state.board = chess.Board()
if "game_over" not in st.session_state:
    st.session_state.game_over = False

st.set_page_config(page_title="ì²´ìŠ¤ vs AI", page_icon="â™Ÿï¸")
st.title("â™Ÿï¸ ì²´ìŠ¤ AIì™€ í•œíŒ ë‘ê¸°")
st.markdown("UCI í¬ë§·ìœ¼ë¡œ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: `e2e4`, `g1f3`")

# ì²´ìŠ¤ ë³´ë“œ ê·¸ë¦¬ê¸°
def draw_board(board):
    svg = chess.svg.board(board=board, size=400)
    cairosvg.svg2png(bytestring=svg.encode('utf-8'), write_to="board.png")
    st.image("board.png", use_column_width=False)

draw_board(st.session_state.board)

# ì‚¬ìš©ì ìˆ˜ ì…ë ¥
move_input = st.text_input("ë‹¹ì‹ ì˜ ìˆ˜:", max_chars=5, help="ì˜ˆ: e2e4")

if st.button("ë‚´ ìˆ˜ ë‘ê¸°") and not st.session_state.game_over:
    try:
        move = chess.Move.from_uci(move_input.strip())
        if move in st.session_state.board.legal_moves:
            st.session_state.board.push(move)

            if not st.session_state.board.is_game_over():
                # Stockfishë¡œ í˜„ì¬ ë³´ë“œ ìƒíƒœ ì„¤ì •
                stockfish.set_fen_position(st.session_state.board.fen())
                ai_move = stockfish.get_best_move()
                if ai_move:
                    st.session_state.board.push_uci(ai_move)
            else:
                st.session_state.game_over = True
        else:
            st.warning("ğŸš« ì˜ëª»ëœ ìˆ˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        st.warning(f"â— ì˜¤ë¥˜: {e}")

    draw_board(st.session_state.board)

# ê²Œì„ ì¢…ë£Œ ë©”ì‹œì§€
if st.session_state.board.is_game_over():
    st.session_state.game_over = True
    result = st.session_state.board.result()
    if st.session_state.board.is_checkmate():
        st.success(f"ì²´í¬ë©”ì´íŠ¸! ê²°ê³¼: {result}")
    elif st.session_state.board.is_stalemate():
        st.info("ìŠ¤í…Œì¼ë©”ì´íŠ¸ (ë¬´ìŠ¹ë¶€)")
    elif st.session_state.board.is_insufficient_material():
        st.info("ê¸°ë¬¼ ë¶€ì¡±ìœ¼ë¡œ ë¬´ìŠ¹ë¶€")
    else:
        st.info(f"ê²Œì„ ì¢…ë£Œ: {result}")

# ìƒˆ ê²Œì„ ë²„íŠ¼
if st.button("ğŸ” ìƒˆ ê²Œì„ ì‹œì‘"):
    st.session_state.board = chess.Board()
    st.session_state.game_over = False
    st.experimental_rerun()
